"use strict";(self.webpackChunkreactjs=self.webpackChunkreactjs||[]).push([[4],{6253:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var s=r(4848),t=r(8453);const o={sidebar_position:5},c="Interceptors",i={id:"interceptors",title:"Interceptors",description:"Interceptor l\xe0 g\xec?",source:"@site/docs/interceptors.md",sourceDirName:".",slug:"/interceptors",permalink:"/axios/interceptors",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"DELETE",permalink:"/axios/http-request-methods/delete"},next:{title:"Cancel request",permalink:"/axios/cancel-request"}},a={},l=[{value:"Interceptor l\xe0 g\xec?",id:"interceptor-l\xe0-g\xec",level:2},{value:"Request interceptor (b\u1ed9 ch\u1eb7n request)",id:"request-interceptor-b\u1ed9-ch\u1eb7n-request",level:2},{value:"Response interceptor (b\u1ed9 ch\u1eb7n response)",id:"response-interceptor-b\u1ed9-ch\u1eb7n-response",level:2},{value:"Refresh token trong interceptor",id:"refresh-token-trong-interceptor",level:2}];function h(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"interceptors",children:"Interceptors"})}),"\n",(0,s.jsx)(n.h2,{id:"interceptor-l\xe0-g\xec",children:"Interceptor l\xe0 g\xec?"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Interceptor"})," c\xf3 th\u1ec3 hi\u1ec3u nh\u01b0 m\u1ed9t b\u01b0\u1edbc t\u01b0\u1eddng l\u01b0\u1edbi ch\u1eb7n c\xe1c ",(0,s.jsx)(n.strong,{children:"request"})," , ",(0,s.jsx)(n.strong,{children:"response"})," c\u1ee7a \u1ee9ng d\u1ee5ng \u0111\u1ec3 cho ph\xe9p ki\u1ec3m tra, thay \u0111\u1ed5i c\xe1c params c\u1ee7a ",(0,s.jsx)(n.strong,{children:"request"})," , ",(0,s.jsx)(n.strong,{children:"response"})," . N\xf3 cho ph\xe9p ch\xfang ta ki\u1ec3m tra c\xe1c token \u1ee9ng d\u1ee5ng, ",(0,s.jsx)(n.code,{children:"Content-Type"})," ho\u1eb7c t\u1ef1 th\xeam ",(0,s.jsx)(n.code,{children:"headers"})," v\xe0o ",(0,s.jsx)(n.strong,{children:"request"})," . \u0110i\u1ec1u n\xe0y cho ph\xe9p ch\xfang ta t\u1eadn d\u1ee5ng t\u1ed1i \u0111a thao t\xe1c ch\u1ec9nh s\u1eeda ",(0,s.jsx)(n.code,{children:"headers"}),", ",(0,s.jsx)(n.code,{children:"body"}),", ",(0,s.jsx)(n.strong,{children:"param request"})," g\u1eedi l\xean server sao cho h\u1ee3p l\xfd nh\u1ea5t, b\u1ea3o m\u1eadt nh\u1ea5t"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"request-interceptor-b\u1ed9-ch\u1eb7n-request",children:"Request interceptor (b\u1ed9 ch\u1eb7n request)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import axios from "axios";\n\nconst ApiClient = axios.create({ baseURL: Config.API_URL });\n\nApiClient.interceptors.request.use(\n  async (config) => {\n    const accessToken = await AsyncStorage.getItem(EStorage.ACCESS_TOKEN);\n    config.headers["Authorization"] = accessToken\n      ? `Bearer ${accessToken}`\n      : "";\n    return config;\n  },\n  (error) => Promise.reject(error)\n);\n'})}),"\n",(0,s.jsx)(n.h2,{id:"response-interceptor-b\u1ed9-ch\u1eb7n-response",children:"Response interceptor (b\u1ed9 ch\u1eb7n response)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import axios, { AxiosError } from "axios";\n\nconst ApiClient = axios.create({ baseURL: Config.API_URL });\n\ntype TErrorResponseData = {\n  id: string;\n  statusCode: number;\n  errorType: string;\n  message: string;\n  error: string;\n};\n\nclass ErrorResponse extends Error {\n  data?: TErrorResponseData;\n  constructor(message: string, data?: TErrorResponseData) {\n    super(message);\n    this.data = data;\n  }\n}\n\nApiClient.interceptors.response.use(\n  (response) => response,\n  async (error: AxiosError<TErrorResponseData>) => {\n    if (error.response?.status === 401) {\n      await AsyncStorage.getAllKeys().then(AsyncStorage.multiRemove); // Lo\u1ea1i b\u1ecf h\u1ebft access_token,... \u0111ang l\u01b0u \u1edf local storage\n      GlobalNavigation.reset(ERootScreenList.GUEST_NAVIGATOR); // Navigate v\u1ec1 m\xe0n \u0111\u0103ng nh\u1eadp\n      throw new ErrorResponse("Login session expired"); // Tr\u1ea3 v\u1ec1 l\u1ed7i v\u1edbi message: "Login session expired"\n    }\n    if (error.response) {\n      const errorResponseData = error.response.data;\n      const errorMessage = errorResponseData.message;\n      throw new ErrorResponse(errorMessage, errorResponseData);\n    }\n    return Promise.reject(error);\n  }\n);\n'})}),"\n",(0,s.jsx)(n.h2,{id:"refresh-token-trong-interceptor",children:"Refresh token trong interceptor"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import axios from "axios";\n\nconst setTokens = (accessToken: string, refreshToken: string) => {\n  localStorage.setItem("accessToken", accessToken);\n  localStorage.setItem("refreshToken", refreshToken);\n};\n\nconst getAccessToken = () => localStorage.getItem("accessToken");\nconst getRefreshToken = () => localStorage.getItem("refreshToken");\nconst clearTokens = () => {\n  localStorage.removeItem("accessToken");\n  localStorage.removeItem("refreshToken");\n};\n\nconst axiosInstance = axios.create({\n  baseURL: "https://your-api.com/api",\n});\n\n// Bi\u1ebfn l\u01b0u tr\u1eef tr\u1ea1ng th\xe1i l\xe0m m\u1edbi token\nlet isRefreshing: boolean = false;\nlet refreshSubscribers: ((newToken: string | null) => void)[] = [];\n\n// H\xe0m \u0111\u0103ng k\xfd l\u1ea1i y\xeau c\u1ea7u khi token \u0111ang \u0111\u01b0\u1ee3c l\xe0m m\u1edbi\nconst onRefreshed = (newToken: string) => {\n  refreshSubscribers.forEach((callback) => callback(newToken));\n  refreshSubscribers = [];\n};\n\naxiosInstance.interceptors.request.use(\n  (config) => {\n    const accessToken = getAccessToken();\n    if (accessToken) {\n      config.headers["Authorization"] = `Bearer ${accessToken}`;\n    }\n    return config;\n  },\n  (error) => Promise.reject(error)\n);\n\naxiosInstance.interceptors.response.use(\n  (response) => response,\n  async (error) => {\n    const originalRequest = error.config;\n\n    // N\u1ebfu nh\u1eadn 401 v\xe0 ch\u01b0a th\u1eed refresh token th\xec x\u1eed l\xfd\n    if (error.response?.status === 401 && !originalRequest._retry) {\n      if (isRefreshing) {\n        return new Promise((resolve, reject) => {\n          refreshSubscribers.push((newToken: string | null) => {\n            if (newToken) {\n              originalRequest.headers["Authorization"] = `Bearer ${newToken}`;\n              resolve(axiosInstance(originalRequest));\n            } else {\n              reject(error);\n            }\n          });\n        });\n      }\n\n      originalRequest._retry = true;\n      isRefreshing = true;\n\n      try {\n        const refreshToken = getRefreshToken();\n        const { data: responseData } = await axios.post(\n          "https://your-api.com/api/auth/refresh",\n          {\n            refreshToken,\n          }\n        );\n\n        const { accessToken: newAccessToken, refreshToken: newRefreshToken } =\n          responseData;\n        setTokens(newAccessToken, newRefreshToken);\n        axiosInstance.defaults.headers[\n          "Authorization"\n        ] = `Bearer ${newAccessToken}`;\n        originalRequest.headers["Authorization"] = `Bearer ${newAccessToken}`;\n        onRefreshed(newAccessToken);\n\n        return axiosInstance(originalRequest);\n      } catch (refreshError) {\n        // \u274c N\u1ebfu refresh token c\u0169ng kh\xf4ng h\u1ee3p l\u1ec7, t\u1eeb ch\u1ed1i t\u1ea5t c\u1ea3 request trong h\xe0ng \u0111\u1ee3i\n        refreshSubscribers.forEach((callback) => callback(null));\n        refreshSubscribers = [];\n\n        clearTokens();\n        window.location.href = "/login";\n\n        return Promise.reject(refreshError);\n      } finally {\n        isRefreshing = false;\n      }\n    }\n\n    return Promise.reject(error);\n  }\n);\n'})})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>i});var s=r(6540);const t={},o=s.createContext(t);function c(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);